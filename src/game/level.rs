//! Spawn the main level.

use bevy::prelude::*;
use std::collections::BTreeMap;
use std::error::Error;
use std::str::FromStr;
use std::sync::{Arc, RwLock};

use crate::game::grid::coords::TileCoords;
use crate::game::grid::tile::{TileEdges, TileFacing, TileMaterial, TileType, tile};
use crate::game::grid::{TileAssets, grid};
use crate::game::object::{ObjectAssets, ObjectType, object};
use crate::{
    Scale,
    asset_tracking::LoadResource,
    audio::music,
    game::player::{PlayerAssets, player},
    screens::Screen,
};

pub(super) fn plugin(app: &mut App) {
    app.load_resource::<LevelAssets>();
}

#[derive(Resource, Asset, Clone, Reflect)]
#[reflect(Resource)]
pub struct LevelAssets {
    #[dependency]
    music: Handle<AudioSource>,
}

impl FromWorld for LevelAssets {
    fn from_world(world: &mut World) -> Self {
        let assets = world.resource::<AssetServer>();
        Self {
            music: assets.load("audio/music/Fluffing A Duck.ogg"),
        }
    }
}

/// A system that spawns the main level.
pub fn spawn_level(
    mut commands: Commands,
    scale: Res<Scale>,
    level_assets: Res<LevelAssets>,
    player_assets: Res<PlayerAssets>,
    tile_assets: Res<TileAssets>,
    object_assets: Res<ObjectAssets>,
    mut texture_atlas_layouts: ResMut<Assets<TextureAtlasLayout>>,
) {
    let level = commands
        .spawn((
            Name::new("Level"),
            Transform::default(),
            Visibility::default(),
            DespawnOnExit(Screen::Gameplay),
            children![
                player(
                    Vec3::new(3.0, 1.0, 3.0),
                    //Vec3::new(0.0, 1.0, 0.0),
                    3.5,
                    &player_assets,
                    &mut texture_atlas_layouts,
                    scale.0
                ),
                (
                    Name::new("Gameplay Music"),
                    music(level_assets.music.clone())
                ),
                object(
                    ObjectType::Rock,
                    &object_assets,
                    Vec3::new(2.0, 1.0, 7.0),
                    scale.0,
                    0.5,
                    0.5,
                ),
            ],
        ))
        .id();

    let grid = create_level(
        commands.reborrow(),
        scale,
        tile_assets,
        texture_atlas_layouts,
    );

    commands.entity(level).add_child(grid);
}

fn create_level(
    mut commands: Commands,
    scale: Res<Scale>,
    tile_assets: Res<TileAssets>,
    mut texture_atlas_layouts: ResMut<Assets<TextureAtlasLayout>>,
) -> Entity {
    let tile_map = Arc::new(RwLock::new(BTreeMap::<TileCoords, Entity>::new()));

    let level_1 = [
        "L=xz:G__,L=z:G___,L=z:G___,L=z:G___,L=z:G___,L=z:G___,L=z:G___,L=z:G___,L=Xz:G__,________,________,________,________,________,________,________,________,________,________,________,",
        "L=x:G___,L:G_____,L:G_____,L:G_____,L:G_____,L:G_____,L:G_____,L:G_____,L=X:G___,________,________,________,________,________,________,________,________,________,________,________,",
        "L=x:G___,L:G_____,L:G_____,L:G_____,L:G_____,L:G_____,L:G_____,L:G_____,L=X:G___,________,________,________,________,________,________,________,________,________,________,________,",
        "L=x:G___,L:G_____,L:G_____,L:G_____,L:G_____,L:G_____,L:G_____,L:G_____,L=X:G___,________,________,________,L=xz:G__,L=z:G___,L=Xz:G__,________,________,________,________,________,",
        "L=x:G___,L:G_____,L:G_____,L:G_____,L:G_____,L:G_____,L:G_____,L:G_____,L:G_____,L=Zz:G__,L=Zz:G__,L=Zz:G__,L:G_____,L:G_____,L=X:G___,________,________,________,________,________,",
        "L=x:G___,L:G_____,L:G_____,L:G_____,L:G_____,L:G_____,L:G_____,L:G_____,L=X:G___,________,________,________,L=xZ:G__,L=Z:G___,L=XZ:G__,________,________,________,________,________,",
        "L=x:G___,L:G_____,L:G_____,L:G_____,L:G_____,L:G_____,L:G_____,L:G_____,L=X:G___,________,________,________,________,________,________,________,________,________,________,________,",
        "L=x:G___,L:G_____,L:G_____,L:G_____,L:G_____,L:G_____,L:G_____,L:G_____,L=X:G___,________,________,________,________,________,________,________,________,________,________,________,",
        "L=xZ:G__,L=Z:G___,L=Z:G___,L=Z:G___,L=Z:G___,L=Z:G___,L=Z:G___,L=Z:G___,L=XZ:G__,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
    ];

    let level_2 = [
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,L=z|S:FP,B=Xz|Z:FP,_______,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,F=|S:FP_,S=z:FP__,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,S=Z:FP__,S=Z:FP__,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,B=x|z:FP,B=X|z:FP,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,B=x:FP__,B=X:FP__,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
    ];

    let level_3 = [
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,B=xz|X:FP,S=x:FP_,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,L=x|S:FP,F=|S:FP_,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
    ];

    let level_4 = [
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,S=Z:FP__,F=|S:FP_,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,B=xZ|z:FP,L=Z|S:FP,_______,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
    ];

    let level_5 = [
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,B=xz:FP_,B=z:FP__,B=z:FP__,B=z:FP__,B=Xz:FP_,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,B=x:FP__,B=Z:FP__,B:FP____,B:FP____,B=X:FP__,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,B=xX:FP_,________,F:FP____,B:FP____,B=X:FP__,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,B=xX:FP_,________,S=X:FP__,B=|x:FP_,B=X:FP__,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,B=xZ:FP_,B=zZ:FP_,B=zZ:FP_,B=Z:FP__,B=ZX:FP_,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
        "________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,________,",
    ];

    let level_layout = [level_1, level_2, level_3, level_4, level_5];

    //let level_layout = [["F:G"]];

    let mut tile_coords = Vec::new();

    for (y, layer) in level_layout.into_iter().enumerate() {
        for (z, row) in layer.into_iter().enumerate() {
            let chars = row.split(',');

            for (x, col) in chars.into_iter().enumerate() {
                let result = col.parse::<TileSettings>();
                if let Ok(tile_settings) = result {
                    tile_coords.push((
                        tile_settings.tile_material,
                        tile_settings.tile_type,
                        TileCoords(IVec3::new(x as i32, y as i32, z as i32)),
                    ));
                } else if !col.replace("_", "").is_empty() && !col.replace(" ", "").is_empty() {
                    println!("Invalid tile settings: {}", col);
                    println!("Err: {}", result.err().unwrap());
                }
            }
        }
    }

    let grid = grid(tile_map.clone(), scale.0);
    let grid = commands.spawn(grid).id();

    for (material, tile_type, coords) in tile_coords {
        let tile = commands
            .spawn(tile(
                tile_type,
                material,
                coords.clone(),
                &tile_assets,
                &mut texture_atlas_layouts,
            ))
            .id();

        commands.entity(grid).add_child(tile);

        tile_map.write().unwrap().insert(coords, tile);
    }

    grid
}

#[derive(Debug)]
pub struct TileSettingsParseError(String);
impl Error for TileSettingsParseError {}
impl std::fmt::Display for TileSettingsParseError {
    fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {
        write!(f, "{}", self.0)
    }
}

struct TileSettings {
    tile_type: TileType,
    tile_material: TileMaterial,
}

impl FromStr for TileSettings {
    type Err = TileSettingsParseError;

    fn from_str(s: &str) -> std::result::Result<Self, Self::Err> {
        let mut parts = s.splitn(2, ':');
        let tile_type = parts
            .next()
            .ok_or_else(|| TileSettingsParseError("No tile type".to_string()))?
            .parse()?;
        let tile_material = parts
            .next()
            .ok_or_else(|| TileSettingsParseError("No tile material".to_string()))?
            .parse()?;

        Ok(Self {
            tile_type,
            tile_material,
        })
    }
}

impl FromStr for TileType {
    type Err = TileSettingsParseError;

    fn from_str(s: &str) -> std::result::Result<Self, Self::Err> {
        let s = s.replace("_", "");

        if s.is_empty() {
            return Err(TileSettingsParseError("No tile".to_string()));
        }

        let mut s = s.split('=');
        let tile_type = s.next().expect("No tile type");
        let data = s.next();

        let data = data.map(|s| s.split('|'));

        match tile_type {
            "F" | "L" | "B" => {
                let edges = if let Some(mut data) = data.clone() && let Some(first) = data.next() {
                    let mut edges = TileEdges::default();

                    if first.contains('X') {
                        edges += TileEdges::pos_x()
                    }
                    if first.contains('x') {
                        edges += TileEdges::neg_x()
                    }
                    if first.contains('Z') {
                        edges += TileEdges::pos_z()
                    }
                    if first.contains('z') {
                        edges += TileEdges::neg_z()
                    }

                    edges
                } else {
                    TileEdges::default()
                };

                match tile_type {
                    "F" => {
                        let is_top = if let Some(mut data) = data {
                            data.next();
                            if let Some(second) = data.next() {
                                !second.contains('S')
                            } else {
                                true
                            }
                        } else {
                            true
                        };

                        Ok(TileType::Full { edges, is_top })
                    }
                    "L" => {
                        let is_top = if let Some(mut data) = data {
                            data.next();
                            if let Some(second) = data.next() {
                                !second.contains('S')
                            } else {
                                true
                            }
                        } else {
                            true
                        };

                        Ok(TileType::Layer { edges, is_top })
                    }
                    "B" => {
                        let facing = if let Some(mut data) = data {
                            data.next();
                            if let Some(second) = data.next() {
                                match second {
                                    "X" => Some(TileFacing::PosX),
                                    "x" => Some(TileFacing::NegX),
                                    "Z" => Some(TileFacing::PosZ),
                                    "z" => Some(TileFacing::NegZ),
                                    _ => None,
                                }
                            } else {
                                None
                            }
                        } else {
                            None
                        };

                        Ok(TileType::Bridge { edges, facing })
                    }
                    _ => unreachable!(),
                }
            }
            "PL" => {
                let mut data = data.expect("Slopes require data");
                let facing = data.next().expect("Slopes require facing");
                let facing = match facing {
                    "X" => TileFacing::PosX,
                    "x" => TileFacing::NegX,
                    "Z" => TileFacing::PosZ,
                    "z" => TileFacing::NegZ,
                    _ => return Err(TileSettingsParseError("Invalid facing".to_string())),
                };

                let has_edge = if let Some(second) = data.next()
                    && second.contains('E')
                {
                    true
                } else {
                    false
                };

                Ok(TileType::SlopeLower {
                    facing,
                    has_edge,
                })
            }
            "PU" => {
                let mut data = data.expect("Slopes require data");
                let facing = data.next().expect("No facing");
                let facing = match facing {
                    "X" => TileFacing::PosX,
                    "x" => TileFacing::NegX,
                    "Z" => TileFacing::PosZ,
                    "z" => TileFacing::NegZ,
                    _ => return Err(TileSettingsParseError("Invalid facing".to_string())),
                };

                let has_edge = if let Some(second) = data.next()
                    && second.contains('E')
                {
                    true
                } else {
                    false
                };

                Ok(TileType::SlopeUpper {
                    facing,
                    has_edge,
                })
            },
            "S" => {
                let mut data = data.expect("Stairs require data");
                let facing = data.next().expect("No facing");
                let facing = match facing {
                    "X" => TileFacing::PosX,
                    "x" => TileFacing::NegX,
                    "Z" => TileFacing::PosZ,
                    "z" => TileFacing::NegZ,
                    _ => return Err(TileSettingsParseError("Invalid facing".to_string())),
                };

                Ok(TileType::Stairs(facing))
            },

            _ => Err(TileSettingsParseError("Invalid tile type".to_string())),
        }
    }
}

impl FromStr for TileMaterial {
    type Err = TileSettingsParseError;

    fn from_str(s: &str) -> std::result::Result<Self, Self::Err> {
        let s = s.replace("_", "");

        match s.as_str() {
            "G" => Ok(TileMaterial::Grass),
            "S" => Ok(TileMaterial::Stone),
            "P" => Ok(TileMaterial::Planks),
            "FP" => Ok(TileMaterial::FramedPlanks),
            _ => Err(TileSettingsParseError("Invalid tile material".to_string())),
        }
    }
}
